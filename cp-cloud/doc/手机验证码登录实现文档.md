# æ‰‹æœºéªŒè¯ç ç™»å½•å®ç°æµç¨‹æ–‡æ¡£ï¼ˆJavaç‰ˆï¼‰

## ğŸ“± ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```mermaid
graph TD
    A[ç”¨æˆ·æ‰‹æœº] -->|è¾“å…¥æ‰‹æœºå·| B[å‰ç«¯ç•Œé¢]
    B -->|è¯·æ±‚éªŒè¯ç | C[cp-auth /sms/send]
    C -->|è°ƒç”¨æœåŠ¡| D[çŸ­ä¿¡æœåŠ¡å•†]
    D -->|å‘é€éªŒè¯ç | A
    B -->|æäº¤éªŒè¯ç | C2[cp-auth /sms/login]
    C2 -->|éªŒè¯æˆåŠŸ| E[TokenService]
    E -->|è¿”å›ä»¤ç‰Œ| B
    B -->|å­˜å‚¨ä»¤ç‰Œ| F[æœ¬åœ°å­˜å‚¨]
```

## ğŸ”§ ç¯å¢ƒé…ç½®

### 1. åç«¯å·¥ç¨‹
- æ¨¡å—ï¼š`cp-auth`ã€`cp-gateway`ã€`cp-modules/cp-system`ã€`cp-common/*`
- JDKï¼š17 æˆ– 11
- æ„å»ºï¼šMaven

### 2. ä¾èµ–
`cp-auth/pom.xml` å¢åŠ ï¼š
```xml
<dependencies>
  <dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>aliyun-java-sdk-dysmsapi</artifactId>
    <version>2.2.1</version>
  </dependency>
  <dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>aliyun-java-sdk-core</artifactId>
    <version>4.5.22</version>
  </dependency>
</dependencies>
```

### 3. é…ç½®
`cp-auth/src/main/resources/application.yml`ï¼š
```yaml
sms:
  code:
    expire-seconds: 300
    daily-limit: 5
    resend-interval-seconds: 60
aliyun:
  sms:
    region-id: cn-hangzhou
    access-key-id: ${ALIYUN_ACCESS_KEY_ID}
    access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET}
    sign-name: ä½ çš„çŸ­ä¿¡ç­¾å
    template-code: SMS_123456789
```

## ğŸš€ åç«¯å®ç°ï¼ˆcp-authï¼‰

### 1. è¯·æ±‚æ¨¡å‹
```java
package com.cp.auth.domain;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Pattern;
public class SmsSendBody {
  @NotBlank
  @Pattern(regexp = "^1[3-9]\\d{9}$")
  private String phone;
  public String getPhone() { return phone; }
  public void setPhone(String phone) { this.phone = phone; }
}
```

```java
package com.cp.auth.domain;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Pattern;
public class SmsLoginBody {
  @NotBlank
  @Pattern(regexp = "^1[3-9]\\d{9}$")
  private String phone;
  @NotBlank
  @Pattern(regexp = "^\\d{6}$")
  private String code;
  public String getPhone() { return phone; }
  public void setPhone(String phone) { this.phone = phone; }
  public String getCode() { return code; }
  public void setCode(String code) { this.code = code; }
}
```

### 2. æ§åˆ¶å™¨
```java
package com.cp.auth.controller;
import com.cp.common.core.domain.R;
import com.cp.auth.domain.SmsSendBody;
import com.cp.auth.domain.SmsLoginBody;
import com.cp.auth.service.SmsLoginService;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import javax.annotation.Resource;
import java.util.Map;

@RestController
@RequestMapping("/sms")
public class SmsTokenController {
  @Resource
  private SmsLoginService smsLoginService;

  @PostMapping("/send")
  public R<Void> send(@Validated @RequestBody SmsSendBody body) {
    smsLoginService.sendCode(body.getPhone());
    return R.ok();
  }

  @PostMapping("/login")
  public R<Map<String, Object>> login(@Validated @RequestBody SmsLoginBody body) {
    Map<String, Object> token = smsLoginService.login(body.getPhone(), body.getCode());
    return R.ok(token);
  }
}
```

### 3. æœåŠ¡ï¼ˆcp-authï¼‰
```java
package com.cp.auth.service;
import com.cp.common.redis.service.RedisService;
import com.cp.common.core.exception.ServiceException;
import com.cp.common.core.utils.StringUtils;
import com.cp.common.security.service.TokenService;
import com.cp.common.core.constant.SecurityConstants;
import com.cp.common.core.domain.R;
import com.cp.system.api.RemoteUserService;
import com.cp.system.api.model.LoginUser;
import com.cp.system.api.domain.SysUser;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import javax.annotation.Resource;
import java.time.Duration;
import java.time.LocalDate;
import java.util.Map;
import java.util.Random;

@Service
public class SmsLoginService {
  @Resource
  private RedisService redisService;
  @Resource
  private SmsSender smsSender;
  @Resource
  private RemoteUserService remoteUserService;
  @Resource
  private TokenService tokenService;
  @Value("${sms.code.expire-seconds:300}")
  private long expireSeconds;
  @Value("${sms.code.daily-limit:5}")
  private int dailyLimit;
  @Value("${sms.code.resend-interval-seconds:60}")
  private long resendInterval;

  public void sendCode(String phone) {
    String lockKey = "sms_lock:" + phone;
    String last = redisService.getCacheObject(lockKey);
    if (StringUtils.isNotEmpty(last)) throw new ServiceException("å‘é€å¤ªé¢‘ç¹");
    String countKey = "sms_count:" + phone + ":" + LocalDate.now();
    Integer cnt = StringUtils.toInteger(redisService.getCacheObject(countKey));
    if (cnt != null && cnt >= dailyLimit) throw new ServiceException("ä»Šæ—¥æ¬¡æ•°å·²è¾¾ä¸Šé™");
    String code = String.format("%06d", new Random().nextInt(1000000));
    smsSender.send(phone, code);
    redisService.setCacheObject("sms_code:" + phone, code, expireSeconds, java.util.concurrent.TimeUnit.SECONDS);
    redisService.setCacheObject(lockKey, "1", resendInterval, java.util.concurrent.TimeUnit.SECONDS);
    redisService.setCacheObject(countKey, String.valueOf((cnt == null ? 0 : cnt) + 1), 1L, java.util.concurrent.TimeUnit.DAYS);
  }

  public Map<String, Object> login(String phone, String code) {
    String cached = redisService.getCacheObject("sms_code:" + phone);
    if (!StringUtils.equals(code, cached)) throw new ServiceException("éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ");
    redisService.deleteObject("sms_code:" + phone);
    R<LoginUser> userResult = remoteUserService.getUserByPhone(phone, SecurityConstants.INNER);
    LoginUser loginUser;
    if (userResult.getCode() == R.FAIL) {
      SysUser nu = new SysUser();
      nu.setUserName(phone);
      nu.setNickName(phone);
      nu.setPhonenumber(phone);
      nu.setStatus("0");
      remoteUserService.registerUserInfo(nu, SecurityConstants.INNER);
      loginUser = remoteUserService.getUserByPhone(phone, SecurityConstants.INNER).getData();
    } else {
      loginUser = userResult.getData();
    }
    return tokenService.createToken(loginUser);
  }
}
```

### 4. å‘é€å™¨ä¸æ¡ä»¶è£…é…
```java
package com.cp.auth.service;
import com.aliyuncs.profile.DefaultProfile;
import com.aliyuncs.DefaultAcsClient;
import com.aliyuncs.dysmsapi.model.v20170525.SendSmsRequest;
import com.aliyuncs.dysmsapi.model.v20170525.SendSmsResponse;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;

@Component
@ConditionalOnProperty(prefix = "sms.mock", name = "enabled", havingValue = "false", matchIfMissing = true)
public class AliyunSmsSender implements SmsSender {
  @Value("${aliyun.sms.region-id}")
  private String regionId;
  @Value("${aliyun.sms.access-key-id}")
  private String accessKeyId;
  @Value("${aliyun.sms.access-key-secret}")
  private String accessKeySecret;
  @Value("${aliyun.sms.sign-name}")
  private String signName;
  @Value("${aliyun.sms.template-code}")
  private String templateCode;

  @Override
  public void send(String phone, String code) {
    DefaultProfile profile = DefaultProfile.getProfile(regionId, accessKeyId, accessKeySecret);
    DefaultAcsClient client = new DefaultAcsClient(profile);
    SendSmsRequest request = new SendSmsRequest();
    request.setPhoneNumbers(phone);
    request.setSignName(signName);
    request.setTemplateCode(templateCode);
    request.setTemplateParam("{\"code\":\"" + code + "\"}");
    SendSmsResponse response = client.getAcsResponse(request);
    if (response == null || !"OK".equalsIgnoreCase(response.getCode())) {
      throw new RuntimeException("çŸ­ä¿¡å‘é€å¤±è´¥");
    }
  }
}
```

## ğŸŒ å‰ç«¯å¯¹æ¥

### 1. æ¥å£
```js
export function sendSmsCode(phone) {
  return request({ url: '/auth/sms/send', method: 'post', data: { phone } })
}
export function smsLogin(phone, code) {
  return request({ url: '/auth/sms/login', method: 'post', data: { phone, code } })
}
```

### 2. é¡µé¢è¦ç‚¹
- æ‰‹æœºå·è¾“å…¥æ ¡éªŒ `^1[3-9]\d{9}$`
- å€’è®¡æ—¶ç¦ç”¨äºŒæ¬¡å‘é€
- ç™»å½•æˆåŠŸåä¿å­˜ `access_token`

## ğŸ” å®‰å…¨ä¸é™æµ
- éªŒè¯ç 5åˆ†é’Ÿæœ‰æ•ˆ
- 60ç§’å†…ä¸å¯é‡å‘
- æ¯æ—¥5æ¬¡é™åˆ¶
- ä½¿ç”¨ `TokenService` å‘æ”¾ä»¤ç‰Œï¼Œä¸ç°æœ‰ä¼šè¯ä¸€è‡´

## ğŸ§ª éªŒè¯ä¸éƒ¨ç½²
- æœ¬åœ°å¯åŠ¨ `cp-auth` ä¸ Redis åæµ‹è¯•æ¥å£
- ç½‘å…³è½¬å‘è·¯å¾„ `/auth/**`ï¼Œåœ¨å‰ç«¯ç»Ÿä¸€èµ°ç½‘å…³åŸŸå

## ğŸ“¦ ä¾èµ–ä¸é…ç½®æ¸…å•
- `cp-common-redis` çš„ `RedisService`
- `cp-common-security` çš„ `TokenService`
- `cp-api-system` çš„ `RemoteUserService`

## âœ… äº¤ä»˜
- æ–°å¢ `cp-auth` ä¸¤ä¸ªç«¯ç‚¹ï¼š`POST /sms/send`ã€`POST /sms/login`
- ä¸ç°æœ‰ç™»å½•æ€å’Œç½‘å…³é‰´æƒå…¼å®¹

## ğŸ§­ å¼€å‘é˜¶æ®µé›¶è´¹ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼ˆä¸»æµç¨‹ä¸å˜ï¼‰

### 1. ç›®æ ‡
- ä¸è°ƒç”¨ç¬¬ä¸‰æ–¹çŸ­ä¿¡é€šé“ã€ä¸äº§ç”Ÿè´¹ç”¨
- ä»ä¿æŒâ€œå‘é€éªŒè¯ç  â†’ æ ¡éªŒéªŒè¯ç  â†’ å‘ä»¤ç‰Œâ€çš„ä¸»æµç¨‹ä¸æ¥å£ä¸å˜
- ä»…åœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒå¯ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒç¦ç”¨

### 2. å¼€å…³ä¸é…ç½®
`cp-auth/src/main/resources/application-dev.yml`ï¼š
```yaml
sms:
  mock:
    enabled: true
    master-code: 000000
    whitelist:
      - 13800138000
      - 13900139001
  code:
    expire-seconds: 300
    daily-limit: 100
    resend-interval-seconds: 2
```

å«ä¹‰ï¼š
- `enabled`ï¼šå¼€å¯æ¨¡æ‹ŸçŸ­ä¿¡é€šé“
- `master-code`ï¼šå¼€å‘ä¸‡èƒ½ç ï¼Œé…åˆç™½åå•æ‰‹æœºå·ä½¿ç”¨
- `whitelist`ï¼šå…è®¸ä½¿ç”¨ä¸‡èƒ½ç çš„æµ‹è¯•æ‰‹æœºå·
- å…¶ä»–å‚æ•°ä¸æ­£å¼ç¯å¢ƒä¸€è‡´ï¼Œä½†å¯æ”¾å®½é¢‘ç‡æ–¹ä¾¿æµ‹è¯•

### 3. è®¾è®¡ä¸å®ç°

#### 3.1 å‘é€å™¨æ¥å£
```java
package com.cp.auth.service;
public interface SmsSender {
  void send(String phone, String code);
}
```

#### 3.2 æ¨¡æ‹Ÿå‘é€å™¨ï¼ˆé›¶è´¹ç”¨ï¼‰
```java
package com.cp.auth.service;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.stereotype.Component;
import org.slf4j.Logger; import org.slf4j.LoggerFactory;

@Component
@ConditionalOnProperty(prefix = "sms.mock", name = "enabled", havingValue = "true")
public class MockSmsSender implements SmsSender {
  private static final Logger log = LoggerFactory.getLogger(MockSmsSender.class);
  @Value("${sms.mock.enabled:false}") private boolean mockEnabled;
  @Override
  public void send(String phone, String code) {
    if (mockEnabled) {
      log.info("[DEV MOCK SMS] phone={} code={}", phone, code);
    }
  }
}
```

#### 3.3 æ­£å¼å‘é€å™¨æ¡ä»¶åŒ–
```java
@Component
@ConditionalOnProperty(prefix = "sms.mock", name = "enabled", havingValue = "false", matchIfMissing = true)
public class AliyunSmsSender implements SmsSender { /* åŒä¸Šå®ç° */ }
```

#### 3.4 æœåŠ¡å±‚å…¼å®¹ä¸‡èƒ½ç 
```java
@Value("${sms.mock.master-code:}")
private String masterCode;
@Value("${sms.mock.whitelist:}")
private java.util.List<String> whitelist;

public Map<String, Object> login(String phone, String code) {
  String cached = redisService.getCacheObject("sms_code:" + phone);
  boolean masterOk = org.apache.commons.lang3.StringUtils.isNotBlank(masterCode)
      && masterCode.equals(code) && whitelist != null && whitelist.contains(phone);
  if (!(org.apache.commons.lang3.StringUtils.equals(code, cached) || masterOk)) {
    throw new ServiceException("éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ");
  }
  if (!masterOk) { redisService.deleteObject("sms_code:" + phone); }
  /* åç»­ä¸æ­£å¼é€»è¾‘ä¸€è‡´ï¼šç”¨æˆ·è·å–/åˆ›å»ºã€ä»¤ç‰Œç”Ÿæˆ */
  /* ... */
  return tokenService.createToken(loginUser);
}
```

#### 3.5 æ§åˆ¶å™¨åœ¨å¼€å‘æ¨¡å¼ä¸‹å›ä¼  devCodeï¼ˆå¯é€‰ï¼‰
```java
@Value("${sms.mock.enabled:false}")
private boolean mockEnabled;

@PostMapping("/send")
public R<java.util.Map<String,Object>> send(@Validated @RequestBody SmsSendBody body) {
  smsLoginService.sendCode(body.getPhone());
  java.util.Map<String,Object> resp = new java.util.HashMap<>();
  resp.put("countdown", 60);
  if (mockEnabled) {
    String code = redisService.getCacheObject("sms_code:" + body.getPhone());
    resp.put("devCode", code);
  }
  return R.ok(resp);
}
```

### 4. å‰ç«¯å¯¹æ¥ä¿æŒä¸å˜
- ä»ç„¶è°ƒç”¨ `POST /auth/sms/send` ä¸ `POST /auth/sms/login`
- å¼€å‘ç¯å¢ƒå¯æ˜¾ç¤º `devCode` ä»¥ä¾¿æ‰‹å·¥è¾“å…¥ï¼›ç”Ÿäº§ç¯å¢ƒæ— æ­¤å­—æ®µ

### 5. å®‰å…¨ä¸åˆ‡æ¢
- æ¨¡æ‹Ÿé€šé“ä»…åœ¨ `dev` æˆ–æµ‹è¯•ç¯å¢ƒå¼€å¯
- ç”Ÿäº§ç¯å¢ƒç¡®ä¿ `sms.mock.enabled=false`
- ä¸‡èƒ½ç ä»…å¯¹ç™½åå•æ‰‹æœºå·ç”Ÿæ•ˆï¼Œé¿å…è¯¯ç”¨
- å‘é€æ—¥å¿—ä»…è¾“å‡ºåˆ°æœ¬åœ°æ—¥å¿—ï¼Œç¦æ­¢å¤–æ³„

### 6. éªŒè¯æ­¥éª¤
- å¯åŠ¨ `cp-auth`ï¼ˆ`spring.profiles.active=dev`ï¼‰
- è°ƒç”¨ `/sms/send`ï¼Œæ”¶åˆ° `devCode`
- ç”¨ `devCode` æˆ–ç™½åå• `master-code` è°ƒç”¨ `/sms/login`ï¼Œæ‹¿åˆ° `access_token`

### 7. è´¹ç”¨å¯¹æ¯”
- æ­£å¼ï¼šæŒ‰çŸ­ä¿¡æœåŠ¡å•†è®¡è´¹
- å¼€å‘ï¼šä¸è°ƒç”¨å¤–éƒ¨çŸ­ä¿¡ï¼Œæ— è´¹ç”¨

## ğŸ“ˆ æ•°æ®æµå›¾

### 1. å‘é€éªŒè¯ç ï¼ˆ/auth/sms/sendï¼‰
```mermaid
flowchart LR
  U[ç”¨æˆ·] --> FE[å‰ç«¯]
  FE -->|POST /auth/sms/send, æºå¸¦å‚æ•°phone| GW[ç½‘å…³]
  GW --> AUTH[cp-auth]
  AUTH -->|æ ¡éªŒé¢‘ç‡/ç”ŸæˆéªŒè¯ç | R[(Redis)]
  AUTH -->|å‘é€éªŒè¯ç | SMS[çŸ­ä¿¡æœåŠ¡å•†]
  SMS --> U
  AUTH -->|è¿”å›R.ok, åŒ…å«countdownã€devCode?| GW
  GW --> FE
```

### 2. éªŒè¯ç ç™»å½•ï¼ˆ/auth/sms/loginï¼‰
```mermaid
flowchart LR
  U[ç”¨æˆ·] --> FE[å‰ç«¯]
  FE -->|POST /auth/sms/login, æºå¸¦å‚æ•°phoneã€code| GW[ç½‘å…³]
  GW --> AUTH[cp-auth]
  AUTH -->|è¯»å–/æ ¡éªŒéªŒè¯ç | R[(Redis)]
  AUTH -->|ç”¨æˆ·è·å–/åˆ›å»º| SYS[cp-system]
  AUTH -->|createToken å†™ä¼šè¯| R
  AUTH -->|è¿”å›R.ok, åŒ…å«access_tokenã€expires_in| GW
  GW --> FE
```

### 3. ä»¤ç‰Œåçš„ä¸šåŠ¡è®¿é—®
```mermaid
flowchart LR
  FE[å‰ç«¯] -->|Authorization: Bearer jwt| GW[ç½‘å…³]
  GW -->|è§£æjwt å¾—user_key| R[(Redis)]
  R -->|åœ¨çº¿æ ¡éªŒ| GW
  GW -->|é€ä¼ ç”¨æˆ·å¤´| SVC[ä¸šåŠ¡æœåŠ¡]
  SVC --> FE
```
### 5. å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆé›¶è´¹ç”¨ï¼‰
```yaml
# cp-auth/src/main/resources/application-dev.yml
sms:
  mock:
    enabled: true
    master-code: 000000
    whitelist:
      - 13800138000
      - 13900139001
  code:
    expire-seconds: 300
    daily-limit: 100
    resend-interval-seconds: 2

aliyun:
  sms:
    region-id: cn-hangzhou
    access-key-id: ${ALIYUN_ACCESS_KEY_ID:}
    access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET:}
    sign-name: ä½ çš„çŸ­ä¿¡ç­¾å
    template-code: SMS_123456789
```

### 6. ç³»ç»ŸæœåŠ¡æ¥å£ï¼ˆcp-systemï¼‰
```java
// cp-api-system: RemoteUserService å¢åŠ 
@GetMapping("/user/phone/{phone}")
public R<LoginUser> getUserByPhone(@PathVariable("phone") String phone, @RequestHeader(SecurityConstants.FROM_SOURCE) String source);

// cp-system: SysUserController å¢åŠ 
@InnerAuth
@GetMapping("/phone/{phone}")
public R<LoginUser> phone(@PathVariable("phone") String phone) {
    SysUser sysUser = userService.selectUserByPhone(phone);
    if (StringUtils.isNull(sysUser)) {
        return R.fail("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    Set<String> roles = permissionService.getRolePermission(sysUser);
    Set<String> permissions = permissionService.getMenuPermission(sysUser);
    LoginUser vo = new LoginUser();
    vo.setSysUser(sysUser);
    vo.setRoles(roles);
    vo.setPermissions(permissions);
    return R.ok(vo);
}
```

### 7. å®ç°æ­¥éª¤æ›´æ–°
- å‘é€éªŒè¯ç ï¼šå‰ç«¯è°ƒç”¨ `/auth/sms/send` â†’ `cp-auth` é€šè¿‡ `SmsSender`ï¼ˆMock/é˜¿é‡Œäº‘ï¼‰å‘é€ â†’ éªŒè¯ç å†™å…¥ `Redis` é”® `sms_code:<phone>`ï¼Œé¢‘ç‡é”® `sms_lock:<phone>`ã€è®¡æ•°é”® `sms_count:<phone>:<date>`
- éªŒè¯ç ç™»å½•ï¼šå‰ç«¯è°ƒç”¨ `/auth/sms/login` â†’ `cp-auth` æ ¡éªŒéªŒè¯ç  â†’ é€šè¿‡ `RemoteUserService.getUserByPhone` è·å–ç”¨æˆ·ï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¿”å›é”™è¯¯ â†’ ä½¿ç”¨ `TokenService.createToken(LoginUser)` åˆ›å»ºä»¤ç‰Œä¸ä¼šè¯ `login_tokens:<user_key>` â†’ è¿”å› `access_token/expires_in`
- å¼€å‘ç¯å¢ƒï¼š`sms.mock.enabled=true` æ—¶å¯ç”¨ `MockSmsSender`ï¼Œæ”¯æŒç™½åå•æ‰‹æœºå·ä½¿ç”¨ `master-code`ï¼Œä¸è°ƒç”¨å¤–éƒ¨çŸ­ä¿¡ï¼Œä¸»æµç¨‹ä¸å˜