# 校园一卡通系统数据库设计文档

## 1. 系统概述

本系统是一个校园一卡通管理系统，包含用户管理、学生管理、商户管理、充值消费、权限管理等功能模块。

## 2. 数据库表结构

### 2.1 用户相关表

#### 2.1.1 用户信息表 (sys_user)

```mermaid
erDiagram
    sys_user {
        bigint user_id PK "用户ID"
        varchar user_name "用户账号"
        varchar nick_name "用户昵称"
        varchar user_type "用户类型"
        varchar email "用户邮箱"
        varchar phonenumber "手机号码"
        char sex "用户性别"
        varchar avatar "头像地址"
        varchar password "密码"
        char status "账号状态"
        char del_flag "删除标志"
        varchar login_ip "最后登录IP"
        datetime login_date "最后登录时间"
        datetime pwd_update_date "密码最后更新时间"
        varchar create_by "创建者"
        datetime create_time "创建时间"
        varchar update_by "更新者"
        datetime update_time "更新时间"
        varchar remark "备注"
    }
```

#### 2.1.2 学生表 (student)

```mermaid
erDiagram
    student {
        bigint id PK "学生ID"
        bigint user_id FK "用户ID"
        varchar student_no "学号"
        varchar grade "年级"
        varchar class_name "班级"
        tinyint gender "性别"
        varchar id_card "身份证号"
        datetime created_at "创建时间"
        datetime updated_at "更新时间"
    }
    
    student ||--o{ sys_user : "belongs to"
```

#### 2.1.3 家长表 (parent)

```mermaid
erDiagram
    parent {
        bigint id PK "家长ID"
        bigint user_id FK "用户ID"
        varchar relation "与学生关系"
        datetime created_at "创建时间"
        datetime updated_at "更新时间"
    }
    
    parent ||--o{ sys_user : "belongs to"
```

#### 2.1.4 用户关系表 (user_relation)

```mermaid
erDiagram
    user_relation {
        bigint id PK "关系ID"
        bigint student_id FK "学生ID"
        bigint parent_id FK "家长ID"
        varchar relation "关系"
        datetime created_at "创建时间"
    }
    
    user_relation }o--|| student : "student"
    user_relation }o--|| parent : "parent"
```

### 2.2 卡片相关表

#### 2.2.1 IC卡表 (ic_card)

```mermaid
erDiagram
    ic_card {
        bigint id PK "卡片ID"
        varchar card_no "卡号"
        bigint student_id FK "学生ID"
        decimal balance "余额"
        tinyint status "状态"
        datetime loss_time "挂失时间"
        datetime created_at "创建时间"
        datetime updated_at "更新时间"
    }
    
    ic_card }o--|| student : "belongs to"
```

### 2.3 商户相关表

#### 2.3.1 商户表 (merchant)

```mermaid
erDiagram
    merchant {
        bigint id PK "商户ID"
        varchar merchant_no "商户编号"
        varchar merchant_name "商户名称"
        varchar merchant_type "商户类型"
        varchar contact_name "联系人"
        varchar contact_phone "联系电话"
        varchar settlement_account "结算账户"
        decimal fee_rate "手续费率"
        tinyint status "状态"
        datetime created_at "创建时间"
        datetime updated_at "更新时间"
    }
```

### 2.4 订单相关表

#### 2.4.1 充值订单表 (recharge_order)

```mermaid
erDiagram
    recharge_order {
        bigint id PK "订单ID"
        varchar order_no "订单号"
        bigint student_id FK "学生ID"
        bigint parent_id FK "家长ID"
        varchar card_no "卡号"
        decimal amount "充值金额"
        varchar channel "支付渠道"
        varchar channel_order_no "渠道订单号"
        tinyint status "状态"
        datetime pay_time "支付时间"
        datetime created_at "创建时间"
        datetime updated_at "更新时间"
    }
    
    recharge_order }o--|| student : "for student"
    recharge_order }o--|| parent : "by parent"
```

#### 2.4.2 消费订单表 (consume_order)

```mermaid
erDiagram
    consume_order {
        bigint id PK "订单ID"
        varchar order_no "订单号"
        bigint student_id FK "学生ID"
        varchar card_no "卡号"
        bigint merchant_id FK "商户ID"
        bigint pos_id "POS终端ID"
        decimal amount "消费金额"
        decimal balance_before "消费前余额"
        decimal balance_after "消费后余额"
        tinyint status "状态"
        datetime consume_time "消费时间"
        datetime created_at "创建时间"
        datetime updated_at "更新时间"
    }
    
    consume_order }o--|| student : "by student"
    consume_order }o--|| merchant : "at merchant"
```

### 2.5 系统管理表

#### 2.5.1 角色表 (sys_role)

```mermaid
erDiagram
    sys_role {
        bigint role_id PK "角色ID"
        varchar role_name "角色名称"
        varchar role_key "角色权限字符串"
        int role_sort "显示顺序"
        char data_scope "数据范围"
        tinyint menu_check_strictly "菜单树选择项是否关联显示"
        char status "角色状态"
        char del_flag "删除标志"
        varchar create_by "创建者"
        datetime create_time "创建时间"
        varchar update_by "更新者"
        datetime update_time "更新时间"
        varchar remark "备注"
    }
```

#### 2.5.2 菜单表 (sys_menu)

```mermaid
erDiagram
    sys_menu {
        bigint menu_id PK "菜单ID"
        varchar menu_name "菜单名称"
        bigint parent_id "父菜单ID"
        int order_num "显示顺序"
        varchar path "路由地址"
        varchar component "组件路径"
        varchar query "路由参数"
        varchar route_name "路由名称"
        int is_frame "是否为外链"
        int is_cache "是否缓存"
        char menu_type "菜单类型"
        char visible "菜单状态"
        char status "菜单状态"
        varchar perms "权限标识"
        varchar icon "菜单图标"
        varchar create_by "创建者"
        datetime create_time "创建时间"
        varchar update_by "更新者"
        datetime update_time "更新时间"
        varchar remark "备注"
    }
```

#### 2.5.3 角色菜单关联表 (sys_role_menu)

```mermaid
erDiagram
    sys_role_menu {
        bigint role_id PK "角色ID"
        bigint menu_id PK "菜单ID"
    }
    
    sys_role_menu }o--|| sys_role : "role"
    sys_role_menu }o--|| sys_menu : "menu"
```

#### 2.5.4 字典类型表 (sys_dict_type)

```mermaid
erDiagram
    sys_dict_type {
        bigint dict_id PK "字典主键"
        varchar dict_name "字典名称"
        varchar dict_type "字典类型"
        char status "状态"
        varchar create_by "创建者"
        datetime create_time "创建时间"
        varchar update_by "更新者"
        datetime update_time "更新时间"
        varchar remark "备注"
    }
```

#### 2.5.5 字典数据表 (sys_dict_data)

```mermaid
erDiagram
    sys_dict_data {
        bigint dict_code PK "字典编码"
        int dict_sort "字典排序"
        varchar dict_label "字典标签"
        varchar dict_value "字典键值"
        varchar dict_type FK "字典类型"
        varchar css_class "样式属性"
        varchar list_class "表格回显样式"
        char is_default "是否默认"
        char status "状态"
        varchar create_by "创建者"
        datetime create_time "创建时间"
        varchar update_by "更新者"
        datetime update_time "更新时间"
        varchar remark "备注"
    }
    
    sys_dict_data }o--|| sys_dict_type : "belongs to"
```

### 2.6 系统日志表

#### 2.6.1 操作日志表 (sys_oper_log)

```mermaid
erDiagram
    sys_oper_log {
        bigint oper_id PK "日志主键"
        varchar title "模块标题"
        int business_type "业务类型"
        varchar method "方法名称"
        varchar request_method "请求方式"
        int operator_type "操作类别"
        varchar oper_name "操作人员"
        varchar oper_url "请求URL"
        varchar oper_ip "主机地址"
        varchar oper_location "操作地点"
        varchar oper_param "请求参数"
        varchar json_result "返回参数"
        int status "操作状态"
        varchar error_msg "错误消息"
        datetime oper_time "操作时间"
        bigint cost_time "消耗时间"
    }
```

#### 2.6.2 登录日志表 (sys_logininfor)

```mermaid
erDiagram
    sys_logininfor {
        bigint info_id PK "访问ID"
        varchar user_name "用户账号"
        varchar ipaddr "登录IP地址"
        char status "登录状态"
        varchar msg "提示信息"
        datetime access_time "访问时间"
    }
```

#### 2.6.3 通知公告表 (sys_notice)

```mermaid
erDiagram
    sys_notice {
        int notice_id PK "公告ID"
        varchar notice_title "公告标题"
        char notice_type "公告类型"
        longblob notice_content "公告内容"
        char status "公告状态"
        varchar create_by "创建者"
        datetime create_time "创建时间"
        varchar update_by "更新者"
        datetime update_time "更新时间"
        varchar remark "备注"
    }
```

## 3. 整体ER图

```mermaid
erDiagram
    sys_user ||--o{ student : "has"
    sys_user ||--o{ parent : "has"
    student ||--o{ ic_card : "owns"
    student ||--o{ user_relation : "has relation"
    parent ||--o{ user_relation : "has relation"
    student ||--o{ recharge_order : "receives"
    parent ||--o{ recharge_order : "creates"
    student ||--o{ consume_order : "makes"
    merchant ||--o{ consume_order : "processes"
    ic_card ||--o{ consume_order : "used in"
    
    sys_role ||--o{ sys_role_menu : "has"
    sys_menu ||--o{ sys_role_menu : "assigned to"
    sys_dict_type ||--o{ sys_dict_data : "contains"
```

## 4. 表关系说明

### 4.1 主要关系

1. **用户-学生关系**：一个用户对应一个学生（一对一）
2. **用户-家长关系**：一个用户对应一个家长（一对一）
3. **学生-IC卡关系**：一个学生可以有多张IC卡（一对多）
4. **学生-家长关系**：通过user_relation表建立多对多关系
5. **充值订单关系**：涉及学生、家长和IC卡三方
6. **消费订单关系**：涉及学生、商户和IC卡三方

### 4.2 系统管理关系

1. **角色-菜单关系**：通过sys_role_menu表建立多对多关系
2. **字典类型-字典数据关系**：一个字典类型包含多个字典数据（一对多）

## 5. 数据字典

### 5.1 用户性别
- 0：男
- 1：女
- 2：未知

### 5.2 账号状态
- 0：正常
- 1：停用

### 5.3 删除标志
- 0：存在
- 2：删除

### 5.4 通知类型
- 1：通知
- 2：公告

### 5.5 订单状态
- 充值订单：0-待支付，1-已支付，2-已关闭
- 消费订单：1-成功，2-失败，3-已退款

### 5.6 IC卡状态
- 0：挂失
- 1：正常
- 2：注销

## 6. 索引设计

### 6.1 主要索引

1. **用户表**：用户账号唯一索引
2. **学生表**：学号唯一索引，班级组合索引
3. **IC卡表**：卡号唯一索引，学生ID索引
4. **商户表**：商户编号唯一索引，商户类型索引
5. **订单表**：订单号唯一索引，相关ID索引

### 6.2 性能优化

1. 经常查询的字段建立索引
2. 外键字段建立索引
3. 时间字段建立索引便于时间范围查询
4. 状态字段建立索引便于状态筛选